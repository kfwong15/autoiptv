name: AutoFetchAndMergeIPTV

on:
  schedule:
    - cron: '*/6 * * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  fetch_merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Download and Merge M3U Files
      run: |
        LINKS=(
          "https://raw.githubusercontent.com/kfwong15/ABC/refs/heads/main/owntv"
        )

        echo "#EXTM3U" > ALL_IPTV.m3u

        for URL in "${LINKS[@]}"; do
          FILE_NAME=$(echo "$URL" | sed 's|https://raw.githubusercontent.com/||' | sed 's|/|_|g').m3u
          echo "📥 下载：$URL → $FILE_NAME"
          wget -q "$URL" -O "$FILE_NAME"

          if [ -s "$FILE_NAME" ]; then
            grep -q "^#EXTM3U" "$FILE_NAME" || sed -i '1i #EXTM3U' "$FILE_NAME"
            tail -n +2 "$FILE_NAME" >> ALL_IPTV.m3u
          else
            echo "❌ 文件为空或下载失败：$FILE_NAME"
          fi
        done

        echo "Auto update at ${GET_TIME}" > README.md

    - name: Add ghproxy.com to China IP links
      run: |
        echo "🌐 添加代理前缀 ghproxy.com"
        sed -i -E 's#(http://(1[23][0-9]|14[0-9]|27[0-9]|36[0-9]|39[0-9]|42[0-9]|43[0-9]|49[0-9]|58[0-9]|59[0-9]|60[0-9]|61[0-9]|100|101|103|106|110|111|112|113|114|115|116|117|118|119|121|122|123|124|125|126|127|139|140|144|150|153|157|159|160|161|162|171|175|180|182|183|202|203|210|211|218|219|220|221|222)\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+/[^ ]*)#https://ghproxy.com/\1#g' ALL_IPTV.m3u

    - name: Verify Links and Keep Only Valid
      run: |
        echo "#EXTM3U" > VALID_IPTV.m3u
        echo "🔍 正在验证频道可用性..."

        IFS=""
        while read -r LINE1 && read -r LINE2; do
          if curl -s --head --connect-timeout 4 --max-time 5 --retry 1 "$LINE2" | grep -q "200 OK"; then
            echo "$LINE1" >> VALID_IPTV.m3u
            echo "$LINE2" >> VALID_IPTV.m3u
          else
            echo "❌ 无法访问：$LINE2"
          fi
        done < <(tail -n +2 ALL_IPTV.m3u | paste - -)

        mv VALID_IPTV.m3u ALL_IPTV.m3u

    - name: Commit and push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"

        git add *.m3u README.md || echo "⚠️ 没有变化"
        git commit -m "Auto update at ${GET_TIME}" || echo "✅ 无需提交"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push || echo "✅ 无需推送"
