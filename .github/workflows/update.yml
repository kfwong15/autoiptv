name: Auto Merge & Validate IPTV

on:
  schedule:
    - cron: '*/6 * * * *'  # æ¯ 6 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Set current time
      run: echo "NOW=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Check working directory and list files
      run: |
        echo "Current directory: $(pwd)"
        ls -la

    - name: Validate & merge IPTV
      run: |
        echo "#EXTM3U" > ALL_IPTV.m3u
        > invalid.txt
        > iptv.log
        > all_blocks.txt

        # è·å–æ‰€æœ‰ .m3u æ–‡ä»¶ï¼ˆæ’é™¤è¾“å‡ºæ–‡ä»¶æœ¬èº«ï¼‰
        FILES=( $(ls *.m3u | grep -v '^ALL_IPTV\.m3u$') )

        for file in "${FILES[@]}"; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            awk -v RS='#EXTINF' 'NR>1{print "#EXTINF" $0}' "$file" | while read -r block; do
              name=$(echo "$block" | grep -oP '(?<=,).*' | head -1 | tr -d '\r')
              url=$(echo "$block" | tail -n1 | tr -d '\r')
              if [[ "$url" =~ \.m3u8$ || "$url" =~ \.mpd$ ]]; then
                echo "$name|||$url|||$block" >> all_blocks.txt
              fi
            done
          fi
        done

        # å»é‡é¢‘é“å
        awk -F '|||' '!seen[$1]++' all_blocks.txt > unique_blocks.txt

        # å¤šçº¿ç¨‹éªŒè¯é“¾æ¥
        cat unique_blocks.txt | cut -d '|||' -f2 | \
        xargs -I {} -P 10 bash -c '
          url="$1"
          line=$(grep "$url" unique_blocks.txt | head -1)
          name=$(echo "$line" | cut -d "|||" -f1)
          block=$(echo "$line" | cut -d "|||" -f3-)
          if curl -s --head --max-time 5 -A "Mozilla/5.0" "$url" | grep -q "200 OK"; then
            echo "$block" >> ALL_IPTV.m3u
            echo "âœ… $name OK" >> iptv.log
          else
            echo "$name <$url>" >> invalid.txt
            echo "âŒ $name FAIL" >> iptv.log
          fi
        ' _ {}

    - name: Update README.md
      run: |
        echo "ğŸ“… æœ€åæ›´æ–°æ—¶é—´: $NOW" > README.md
        echo "" >> README.md
        echo "ğŸ“º [ç‚¹å‡»ä¸‹è½½æœ€æ–° IPTV åˆ—è¡¨](./ALL_IPTV.m3u)" >> README.md
        echo "" >> README.md
        echo "âœ… æœ‰æ•ˆé¢‘é“æ•°é‡: $(grep -c '#EXTINF' ALL_IPTV.m3u)" >> README.md
        echo "âŒ æ— æ•ˆé¢‘é“æ•°é‡: $(wc -l < invalid.txt)" >> README.md

    - name: Commit & push changes
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"
        git pull origin main || true
        git add ALL_IPTV.m3u invalid.txt README.md iptv.log || echo "âš ï¸ Nothing to add"
        git
