name: AutoFetchAndMergeIPTV

on:
  schedule:
    - cron: '*/6 * * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  fetch_merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Download, Clean and Merge
      run: |
        LINKS=(
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSS"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSTORE-PRIMETV"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/Kiki"
        )

        echo "#EXTM3U" > ALL_IPTV.m3u
        TEMP_FILE="temp_iptv.txt"
        > "$TEMP_FILE"

        for URL in "${LINKS[@]}"; do
          echo "ğŸŒ æ­£åœ¨ä¸‹è½½ï¼š$URL"

          FILE_NAME=$(echo "$URL" | sed 's|https://raw.githubusercontent.com/||' | sed 's|/|_|g').m3u
          wget -q "$URL" -O "$FILE_NAME"

          if [ -s "$FILE_NAME" ]; then
            echo "âœ… ä¸‹è½½æˆåŠŸï¼š$FILE_NAME"
            grep -q "^#EXTM3U" "$FILE_NAME" || sed -i '1i #EXTM3U' "$FILE_NAME"
            sed -i '/^\s*$/d' "$FILE_NAME"

            # è§£ææ¯ä¸ªé¢‘é“æ¡ç›®
            awk -v RS='#EXTINF' 'NR>1{print "#EXTINF" $0}' "$FILE_NAME" | while read -r block; do
              NAME=$(echo "$block" | grep -oP '(?<=,).*' | head -1)
              URL=$(echo "$block" | tail -n1)

              # æ£€æŸ¥ URL æ˜¯å¦å¯è®¿é—®ï¼ˆå¿½ç•¥ SSL é”™è¯¯ï¼‰
              if curl -s --head --max-time 5 --insecure "$URL" | grep -q "200 OK"; then
                # å»é‡åˆ¤æ–­ï¼šé¢‘é“åä¸èƒ½é‡å¤
                if ! grep -q ",$NAME$" "$TEMP_FILE"; then
                  echo "$block" >> "$TEMP_FILE"
                else
                  echo "âš ï¸ è·³è¿‡é‡å¤é¢‘é“ï¼š$NAME"
                fi
              else
                echo "âŒ æ— æ³•è®¿é—®ï¼š$NAME <$URL>"
              fi
            done

          else
            echo "âŒ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼š$FILE_NAME"
            rm -f "$FILE_NAME"
          fi
        done

        # åˆå¹¶æœ‰æ•ˆé¢‘é“
        cat "$TEMP_FILE" >> ALL_IPTV.m3u
        rm -f "$TEMP_FILE"

        echo "Auto update at ${GET_TIME}" > README.md

    - name: Commit and push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"

        git add *.m3u README.md || echo "âš ï¸ æ²¡æœ‰å˜åŒ–"
        git commit -m "Auto update at ${GET_TIME}" || echo "âœ… æ— éœ€æäº¤"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push || echo "âœ… æ— éœ€æ¨é€"
