name: AutoFetchIPTV

on:
  schedule:
    - cron: '*/6 * * * *'  # æ¯ 6 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ‰‹åŠ¨è¿è¡Œæ”¯æŒ

env:
  TZ: Asia/Shanghai

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Set time
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Download and save IPTV files
      run: |
        echo "ğŸ“¦ å¼€å§‹é‡‡é›†æ‰€æœ‰é“¾æ¥..."

        LINKS=(
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSS"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSTORE-PRIMETV"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/Kiki"
          "https://raw.githubusercontent.com/kfwong15/ABC/refs/heads/main/owntv"
        )

        for IPTV_URL in "${LINKS[@]}"; do
          echo "âœ… å¤„ç†é“¾æ¥: $IPTV_URL"

          # è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶åï¼ˆå¦‚ kiki4177_iptv_main_JSS.m3uï¼‰
          FILE_NAME=$(echo "$IPTV_URL" | sed 's|https://raw.githubusercontent.com/||' | sed 's|/|_|g').m3u
          echo "ğŸ“„ æ–‡ä»¶åä¸º: $FILE_NAME"

          # ä¸‹è½½æ–‡ä»¶
          wget -q "$IPTV_URL" -O "$FILE_NAME"

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ ! -s "$FILE_NAME" ]; then
            echo "âŒ å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º: $FILE_NAME"
            continue
          fi

          # æ·»åŠ  #EXTM3U å¼€å¤´ï¼ˆå¦‚æ²¡æœ‰ï¼‰
          grep -q "^#EXTM3U" "$FILE_NAME" || sed -i '1i #EXTM3U' "$FILE_NAME"

          echo "âœ… æˆåŠŸä¿å­˜ $FILE_NAME"
        done

        # æ›´æ–° README.md æ˜¾ç¤ºæœ€åæ›´æ–°æ—¶é—´
        echo "ğŸ“… Last updated at ${GET_TIME}" > README.md

    - name: Commit and push to GitHub
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"

        git add . || echo "âš ï¸ æ— éœ€æ·»åŠ "
        git commit -m "ğŸ¯ Auto fetch at ${GET_TIME}" || echo "âœ… æ— éœ€æäº¤"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push || echo "âœ… æ— éœ€æ¨é€"
