name: AutoFetchAndMergeIPTV

on:
  schedule:
    - cron: '*/6 * * * *'  # ÊØè6ÂàÜÈíüËøêË°å‰∏ÄÊ¨°
  workflow_dispatch:        # ÊîØÊåÅÊâãÂä®ËøêË°å

env:
  TZ: Asia/Shanghai

jobs:
  fetch_merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get current time
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Download, Clean, and Merge M3U Files (Skip Validation)
      run: |
        LINKS=(
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSS"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSTORE-PRIMETV"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/Kiki"
          "https://raw.githubusercontent.com/kfwong15/ABC/refs/heads/main/owntv"
        )

        echo "#EXTM3U" > ALL_IPTV.m3u
        TEMP_ALL="temp_merge.txt"
        > "$TEMP_ALL"

        for URL in "${LINKS[@]}"; do
          FILE_NAME=$(echo "$URL" | sed 's|https://raw.githubusercontent.com/||' | sed 's|/|_|g').m3u
          echo "üì• ‰∏ãËΩΩÔºö$URL ‚Üí $FILE_NAME"
          wget -q "$URL" -O "$FILE_NAME"

          if [ -s "$FILE_NAME" ]; then
            grep -q "^#EXTM3U" "$FILE_NAME" || sed -i '1i #EXTM3U' "$FILE_NAME"
            sed -i '/^\s*$/d' "$FILE_NAME"

            total_lines=$(wc -l < "$FILE_NAME")
            i=1
            while [ $i -le $total_lines ]; do
              LINE1=$(sed -n "${i}p" "$FILE_NAME")
              LINE2=$(sed -n "$((i+1))p" "$FILE_NAME")

              if [[ "$LINE1" == \#EXTINF* ]] && [[ "$LINE2" == http* ]]; then
                NAME=$(echo "$LINE1" | sed -n 's/^.*,//p' | tr -d '\r\n')

                if ! grep -q ",$NAME$" "$TEMP_ALL"; then
                  echo "$LINE1" >> "$TEMP_ALL"
                  echo "$LINE2" >> "$TEMP_ALL"
                else
                  echo "‚ö†Ô∏è ÈáçÂ§çÈ¢ëÈÅìÔºö$NAMEÔºåÂ∑≤Ë∑≥Ëøá"
                fi
              fi

              i=$((i+1))
            done
          else
            echo "‚ùå Êñá‰ª∂‰∏∫Á©∫Êàñ‰∏ãËΩΩÂ§±Ë¥•Ôºö$FILE_NAME"
          fi
