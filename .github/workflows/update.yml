name: AutoFetchIPTV

on:
  schedule:
    - cron: '*/6 * * * *'  # æ¯ 6 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  IPTV_URL: "https://raw.githubusercontent.com/kiki4177/iptv/refs/heads/main/JSS"

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Get Time
      run: echo "GET_TIME=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Download and Create File from URL
      run: |
        echo "ğŸ“¥ ä¸‹è½½é“¾æ¥ï¼š$IPTV_URL"

        # æå–æ–‡ä»¶åï¼Œç¡®ä¿ä¸ä¼šä¸ºç©º
        FILE_NAME=$(echo "$IPTV_URL" | sed 's|https://raw.githubusercontent.com/||' | sed 's|/|_|g')

        # éªŒè¯æ–‡ä»¶å
        if [ -z "$FILE_NAME" ]; then
          echo "âŒ æ— æ³•ç”Ÿæˆæ–‡ä»¶åï¼Œç»ˆæ­¢"
          exit 1
        fi

        echo "ğŸ“„ ä¿å­˜æ–‡ä»¶ä¸ºï¼š$FILE_NAME"

        # ä¸‹è½½
        wget "$IPTV_URL" -O "$FILE_NAME" || echo "" > "$FILE_NAME"

        # æ·»åŠ å¤´éƒ¨
        grep -q "^#EXTM3U" "$FILE_NAME" || sed -i '1i #EXTM3U' "$FILE_NAME"

        # å†™å…¥æ›´æ–°è¯´æ˜
        echo "Auto update at ${GET_TIME}" > README.md

    - name: Commit and Push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"

        # å®‰å…¨ addï¼šç¡®ä¿æ–‡ä»¶å­˜åœ¨
        if [ -f "$FILE_NAME" ]; then
          git add "$FILE_NAME" README.md
          git commit -m "Updated $FILE_NAME at ${GET_TIME}" || echo "âœ… æ— éœ€æäº¤"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push || echo "âœ… æ— éœ€æ¨é€"
        else
          echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æäº¤"
        fi
