name: Merge and Validate IPTV

on:
  schedule:
    - cron: '*/6 * * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  validate_merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Prepare files
      run: |
        echo "#EXTM3U" > ALL_IPTV.m3u
        > invalid.txt
        > iptv.log
        > all_blocks.txt

        FILES=$(ls *.m3u | grep -v ALL_IPTV || true)

        for file in $FILES; do
          echo "ğŸ” å¤„ç†æ–‡ä»¶ï¼š$file"
          awk -v RS='#EXTINF' 'NR>1{print "#EXTINF" $0}' "$file" | while read -r block; do
            name=$(echo "$block" | grep -oP '(?<=,).*' | head -1 | tr -d '\r')
            url=$(echo "$block" | tail -n1 | tr -d '\r')
            if [[ "$url" =~ \.m3u8$ || "$url" =~ \.mpd$ ]]; then
              echo "$name|||$url|||$block" >> all_blocks.txt
            fi
          done
        done

    - name: Sort by speed and deduplicate
      run: |
        mkdir -p checked
        sort all_blocks.txt | uniq > deduped_blocks.txt

        # æ£€æŸ¥é‡å¤é¢‘é“ï¼Œä¿ç•™æœ€å¿«
        awk -F '|||' '{print $1}' deduped_blocks.txt | sort | uniq > names.txt

        while read -r name; do
          grep "^$name|||" deduped_blocks.txt > "checked/$name.txt"
          best_line=""
          best_time=9999

          while IFS='|||' read -r cname curl cblock; do
            start=$(date +%s%3N)
            if curl -s --head --max-time 5 -A "Mozilla/5.0" "$curl" | grep -q "200 OK"; then
              end=$(date +%s%3N)
              rtt=$((end - start))
              if (( rtt < best_time )); then
                best_time=$rtt
                best_line="$cblock"
              fi
            else
              echo "$cname <$curl>" >> invalid.txt
              echo "âŒ $cname FAIL ($curl)" >> iptv.log
            fi
          done < "checked/$name.txt"

          if [ -n "$best_line" ]; then
            echo "$best_line" >> ALL_IPTV.m3u
            echo "âœ… $name OK (best RTT ${best_time}ms)" >> iptv.log
          fi
        done < names.txt

    - name: Update time
      run: echo "ğŸ“… æœ€åæ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" > README.md

    - name: Commit & push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"
        git pull origin main || true
        git add ALL_IPTV.m3u invalid.txt iptv.log README.md || echo "âš ï¸ æ— å˜åŒ–"
        git commit -m "âœ… Auto update IPTV $(date +'%Y-%m-%d %H:%M:%S')" || echo "âœ… æ— éœ€æäº¤"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push || echo "âœ… æ— éœ€æ¨é€"
