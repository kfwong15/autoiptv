name: Auto Check IPTV Pro

on:
  schedule:
    - cron: '*/6 * * * *'  # æ¯6åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  validate_iptv:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Prepare and collect links
      run: |
        mkdir -p temp
        cd temp
        > ../ALL_IPTV.m3u
        echo "#EXTM3U" > ../ALL_IPTV.m3u
        > ../invalid.txt
        > ../iptv.log
        > all_blocks.txt

        LINKS=(
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSS"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSTORE-PRIMETV"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/Kiki"
          "https://raw.githubusercontent.com/kfwong15/ABC/refs/heads/main/owntv"
        )

        for url in "${LINKS[@]}"; do
          fname=$(echo "$url" | sed 's|https://||;s|/|_|g')
          curl -sL "$url" -o "$fname"
          echo "ðŸ”— ä¸‹è½½å®Œæˆ: $fname"

          # åˆ¤æ–­æ˜¯å¦æ˜¯ M3U æ ¼å¼
          if grep -q "#EXTINF" "$fname"; then
            awk -v RS='#EXTINF' 'NR>1{print "#EXTINF" $0}' "$fname" | while read -r block; do
              name=$(echo "$block" | grep -oP '(?<=,).*' | head -1 | tr -d '\r')
              link=$(echo "$block" | tail -n1 | tr -d '\r')
              if [[ "$link" =~ \.m3u8$ || "$link" =~ \.mpd$ ]]; then
                echo "$name|||$link|||$block" >> all_blocks.txt
              fi
            done
          else
            # å¦‚æžœæ²¡æœ‰EXTINFï¼Œä¹Ÿå°è¯•æå– .m3u8 / .mpd æ’­æ”¾é“¾æŽ¥
            grep -Eo 'https?://[^"]+\.(m3u8|mpd)' "$fname" | while read -r link; do
              name=$(basename "$link")
              echo "#EXTINF:-1,$name" > tempblock.txt
              echo "$link" >> tempblock.txt
              block=$(cat tempblock.txt)
              echo "$name|||$link|||$block" >> all_blocks.txt
            done
          fi
        done

    - name: Validate IPTV (multi-threaded)
      run: |
        cd temp
        awk -F '|||' '!a[$1]++' all_blocks.txt > unique_blocks.txt

        cat unique_blocks.txt | cut -d '|||' -f2 | \
        xargs -I {} -P 10 bash -c '
          url="$1"
          name=$(grep "$url" unique_blocks.txt | head -1 | cut -d "|||" -f1)
          block=$(grep "$url" unique_blocks.txt | head -1 | cut -d "|||" -f3-)
          if curl -s --head --max-time 5 -A "Mozilla/5.0" -e "https://www.google.com" "$url" | grep -q "200 OK"; then
            echo "$block" >> ../ALL_IPTV.m3u
            echo "âœ… $name OK" >> ../iptv.log
          else
            echo "$name <$url>" >> ../invalid.txt
            echo "âŒ $name FAIL" >> ../iptv.log
          fi
        ' _ {}

    - name: Write update time
      run: |
        echo "ðŸ“… æœ€åŽæ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" > README.md

    - name: Commit & Push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"
        git pull origin main || true
        git add ALL_IPTV.m3u invalid.txt README.md iptv.log || true
        git commit -m "ðŸŽ¯ Auto update at $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push || echo "No changes to push"
