name: AutoFetchAndFilterIPTV

on:
  schedule:
    - cron: '*/6 * * * *'  # æ¯6åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  fetch_filter:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Set current time
      run: echo "TIME_NOW=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Fetch and Validate IPTV Streams
      run: |
        mkdir -p tmp && cd tmp

        # å®šä¹‰ IPTV æºé“¾æ¥
        LINKS=(
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSS"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/JSTORE-PRIMETV"
          "https://raw.githubusercontent.com/kiki4177/iptv/main/Kiki"
          "https://raw.githubusercontent.com/kfwong15/ABC/refs/heads/main/owntv"
        )

        # åˆå§‹åŒ–æ–‡ä»¶
        echo "#EXTM3U" > ../ALL_IPTV.m3u
        > ../invalid.txt
        > all_blocks.txt

        for URL in "${LINKS[@]}"; do
          FILENAME=$(basename "$URL").m3u
          echo "ğŸ“¥ ä¸‹è½½ $URL"
          curl -s "$URL" -o "$FILENAME"

          if [ -s "$FILENAME" ]; then
            grep -q "^#EXTM3U" "$FILENAME" || sed -i '1i #EXTM3U' "$FILENAME"
            sed -i '/^\s*$/d' "$FILENAME"

            awk -v RS='#EXTINF' 'NR>1{print "#EXTINF" $0}' "$FILENAME" | while read -r BLOCK; do
              NAME=$(echo "$BLOCK" | grep -oP '(?<=,).*' | head -1)
              STREAM_URL=$(echo "$BLOCK" | tail -n1)
              echo "$NAME|||$STREAM_URL|||$BLOCK" >> all_blocks.txt
            done
          else
            echo "âš ï¸ æºæ–‡ä»¶ $URL ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
          fi
        done

        echo "ğŸ” å¼€å§‹å¹¶å‘éªŒè¯é¢‘é“æ˜¯å¦å¯ç”¨..."

        cat all_blocks.txt | sort -u | xargs -P 10 -I {} bash -c '
          LINE="{}"
          IFS="|||" read -r NAME STREAM_URL BLOCK <<< "$LINE"

          if curl -s --head --max-time 5 \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
              -H "Referer: https://www.google.com" \
              "$STREAM_URL" | grep -q "200 OK"; then
              echo "$BLOCK" >> ../ALL_IPTV.m3u
              echo "âœ… $NAME"
          else
              echo "$NAME <$STREAM_URL>" >> ../invalid.txt
              echo "âŒ $NAME"
          fi
        '

        echo "ğŸ“ æ›´æ–°è¯´æ˜: ${TIME_NOW}"
        echo "æœ€åæ›´æ–°æ—¶é—´ï¼š${TIME_NOW}" > ../README.md

    - name: Commit and Push
      run: |
        git config --global user.name "kfwong15"
        git config --global user.email "kfwong15@users.noreply.github.com"
        git pull origin main || true
        git add ALL_IPTV.m3u README.md invalid.txt || echo "âš ï¸ æ²¡æœ‰å˜æ›´"
        git commit -m "âœ… Auto Update IPTV at ${TIME_NOW}" || echo "â„¹ï¸ æ— éœ€æäº¤"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push || echo "â„¹ï¸ æ— éœ€æ¨é€"
